<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a2e">
    <title>Electricity Price - Denmark</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding: 16px; }
        .standalone-card { max-width: 500px; margin: 0 auto; }
        .chart-container { height: 250px; margin-top: 16px; }
        .region-toggle { display: flex; gap: 8px; margin-bottom: 16px; justify-content: center; }
        .region-toggle button { padding: 8px 16px; border: none; border-radius: 8px; background: #2a2a4e; color: #a0a0b8; cursor: pointer; }
        .region-toggle button.active { background: #4ade80; color: #1a1a2e; }
        .last-update { text-align: center; color: #666; font-size: 12px; margin-top: 12px; }
    </style>
</head>
<body>
    <div class="standalone-card">
        <div class="region-toggle">
            <button id="dk1-btn">DK1 (West)</button>
            <button id="dk2-btn" class="active">DK2 (East)</button>
        </div>
        <section class="price-card electricity-card">
            <div class="card-header">
                <span class="card-icon">âš¡</span>
                <span class="card-title">Electricity</span>
            </div>
            <div class="card-subtitle">Spot price + Grid costs</div>
            <div class="current-price">
                <span class="price-value" id="elec-price">--</span>
                <span class="price-unit">DKK/kWh</span>
            </div>
            <div class="price-breakdown">
                <span class="breakdown-item">Spot: <span id="spot-price">--</span></span>
                <span class="breakdown-item">Grid: <span id="grid-cost">--</span></span>
            </div>
            <div class="price-details">
                <div class="detail-item">
                    <span class="detail-label">Min</span>
                    <span class="detail-value" id="elec-min">--</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Max</span>
                    <span class="detail-value" id="elec-max">--</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Avg</span>
                    <span class="detail-value" id="elec-avg">--</span>
                </div>
            </div>
        </section>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
        <div class="last-update" id="last-updated"></div>
    </div>

    <script>
        const CONFIG = {
            API_BASE: 'https://api.energidataservice.dk/dataset/Elspotprices',
            MWH_TO_KWH: 1000,
            VAT: 1.25,
            // Fixed fees (DKK/kWh without VAT)
            FIXED_FEES: { transmission: 0.049, system: 0.054, elafgift: 0.00872 },
            // Distribution tariffs by region (DKK/kWh without VAT) - 2025/2026 winter rates
            GRID_TARIFFS: {
                DK1: { LOW: 0.1536, MEDIUM: 0.4098, HIGH: 0.9821 },
                DK2: { LOW: 0.1863, MEDIUM: 0.5477, HIGH: 1.3520 }
            },
            REFRESH_INTERVAL: 5 * 60 * 1000
        };

        let state = { region: 'DK2', prices: [] };
        let chart = null;

        document.getElementById('dk1-btn').onclick = () => setRegion('DK1');
        document.getElementById('dk2-btn').onclick = () => setRegion('DK2');

        function setRegion(region) {
            state.region = region;
            document.querySelectorAll('.region-toggle button').forEach(b => b.classList.remove('active'));
            document.getElementById(region.toLowerCase() + '-btn').classList.add('active');
            fetchPrices();
        }

        function getFeesWithVAT(hour) {
            const tariffs = CONFIG.GRID_TARIFFS[state.region];
            const fixed = CONFIG.FIXED_FEES;
            let distributionTariff;
            if (hour >= 0 && hour < 6) distributionTariff = tariffs.LOW;
            else if (hour >= 17 && hour < 21) distributionTariff = tariffs.HIGH;
            else distributionTariff = tariffs.MEDIUM;
            
            return (distributionTariff + fixed.transmission + fixed.system + fixed.elafgift) * CONFIG.VAT;
        }

        function calculateTotalPrice(spotBeforeVAT, hour) {
            const tariffs = CONFIG.GRID_TARIFFS[state.region];
            const fixed = CONFIG.FIXED_FEES;
            let distributionTariff;
            if (hour >= 0 && hour < 6) distributionTariff = tariffs.LOW;
            else if (hour >= 17 && hour < 21) distributionTariff = tariffs.HIGH;
            else distributionTariff = tariffs.MEDIUM;
            
            const totalBeforeVAT = spotBeforeVAT + distributionTariff + fixed.transmission + fixed.system + fixed.elafgift;
            return totalBeforeVAT * CONFIG.VAT;
        }

        async function fetchPrices() {
            try {
                const now = new Date();
                const start = new Date(now); start.setHours(0,0,0,0);
                const end = new Date(start); end.setDate(end.getDate() + 2);
                
                const filter = encodeURIComponent(JSON.stringify({ PriceArea: state.region }));
                const url = `${CONFIG.API_BASE}?start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}&filter=${filter}&sort=HourDK%20asc`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.records?.length) {
                    processPrices(data.records);
                }
            } catch (e) { console.error(e); }
        }

        function processPrices(records) {
            const now = new Date();
            const todayStart = new Date(now); todayStart.setHours(0,0,0,0);
            const todayEnd = new Date(todayStart); todayEnd.setDate(todayEnd.getDate() + 1);
            
            state.prices = records.map(r => {
                const time = new Date(r.HourDK);
                const spotDKK = r.SpotPriceDKK !== null ? r.SpotPriceDKK : (r.SpotPriceEUR * 7.45);
                const spotBeforeVAT = spotDKK / CONFIG.MWH_TO_KWH;
                const hour = time.getHours();
                const spotWithVAT = spotBeforeVAT * CONFIG.VAT;
                const fees = getFeesWithVAT(hour);
                const total = calculateTotalPrice(spotBeforeVAT, hour);
                return { time, hour, spot: spotWithVAT, grid: fees, total };
            }).filter(p => p.time >= todayStart && p.time < todayEnd);
            
            updateDisplay();
            updateChart();
        }

        function updateDisplay() {
            const now = new Date();
            const current = state.prices.find(p => p.time <= now && new Date(p.time.getTime() + 3600000) > now) || state.prices[0];
            
            if (current) {
                const el = document.getElementById('elec-price');
                el.textContent = current.total.toFixed(2);
                el.className = 'price-value ' + (current.total < 1.5 ? 'cheap' : current.total < 3 ? 'moderate' : 'expensive');
                document.getElementById('spot-price').textContent = current.spot.toFixed(2);
                document.getElementById('grid-cost').textContent = current.grid.toFixed(2);
            }
            
            if (state.prices.length) {
                const totals = state.prices.map(p => p.total);
                document.getElementById('elec-min').textContent = Math.min(...totals).toFixed(2);
                document.getElementById('elec-max').textContent = Math.max(...totals).toFixed(2);
                document.getElementById('elec-avg').textContent = (totals.reduce((a,b) => a+b, 0) / totals.length).toFixed(2);
            }
            
            document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString('da-DK', {hour:'2-digit', minute:'2-digit'});
        }

        function updateChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (chart) chart.destroy();
            
            const colors = state.prices.map(p => p.total < 1.5 ? '#4ade80' : p.total < 3 ? '#fbbf24' : '#f87171');
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: state.prices.map(p => p.hour.toString().padStart(2, '0')),
                    datasets: [
                        { label: 'Spot', data: state.prices.map(p => p.spot), backgroundColor: colors, stack: 'price' },
                        { label: 'Grid', data: state.prices.map(p => p.grid), backgroundColor: 'rgba(128,128,128,0.5)', stack: 'price' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { color: '#a0a0b8' } },
                        y: { stacked: true, beginAtZero: true, ticks: { color: '#a0a0b8' } }
                    }
                }
            });
        }

        fetchPrices();
        setInterval(fetchPrices, CONFIG.REFRESH_INTERVAL);
    </script>
</body>
</html>
